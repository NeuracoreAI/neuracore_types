name: Generate Types and Publish

# Only triggered by centralized release system or manual emergency release
# No longer triggers on PR merge to main
on:
  repository_dispatch:
    types: [trigger-release]
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      confirm_emergency:
        description: 'Type CONFIRM for emergency release'
        required: true
        type: string

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      bump_type: ${{ steps.validate.outputs.bump_type }}
    steps:
      - name: Validate trigger
        id: validate
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "âœ… Triggered by centralized release system"
            echo "bump_type=${{ github.event.client_payload.bump_type }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.confirm_emergency }}" != "CONFIRM" ]]; then
              echo "::error::Emergency release requires typing 'CONFIRM' in the confirmation field"
              exit 1
            fi
            echo "::warning::ðŸš¨ EMERGENCY RELEASE - triggered manually"
            echo "bump_type=${{ inputs.bump_type }}" >> $GITHUB_OUTPUT
          fi

  generate-types:
    needs: validate
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Install Node dependencies
      run: npm install

    - name: Generate TypeScript types
      run: python scripts/generate_types.py

    - name: Build TypeScript
      run: npm run build

  version-bump:
    needs: [validate, generate-types]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}

    steps:
    - name: Generate GitHub App Token
      id: generate-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ vars.NC_VERSION_BUMPER_APP_ID }}
        private-key: ${{ secrets.NC_VERSION_BUMPER_PRIVATE_KEY }}

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ steps.generate-token.outputs.token }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        pip install bump2version
        npm install -g json

    - name: Bump version
      id: bump
      run: |
        BUMP_TYPE="${{ needs.validate.outputs.bump_type }}"
        
        echo "Bumping $BUMP_TYPE version"

        # Configure git
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        
        # Use bump2version to bump the version
        bump2version $BUMP_TYPE --allow-dirty
        NEW_VERSION=$(grep -m 1 'version = ' pyproject.toml | cut -d'"' -f2)
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                
        git push origin main --tags

  publish-python:
    needs: version-bump
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Pull latest changes
      run: |
        git pull --tags
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install build tools
      run: |
        pip install --upgrade pip
        pip install build twine
    
    - name: Build Python package
      run: python -m build
    
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
      run: twine upload --skip-existing dist/*

  publish-npm:
    needs: version-bump
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Pull latest changes
      run: |
        git pull --tags
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Install Python dependencies
      run: pip install -e ".[dev]"
    
    - name: Update npm 
      run: npm install -g npm@latest

    - name: Install Node dependencies
      run: npm install
    
    - name: Generate TypeScript types
      run: python scripts/generate_types.py
    
    - name: Publish to NPM
      run: npm publish

  create-release:
    needs: [version-bump, publish-python, publish-npm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Pull latest changes
      run: git pull --tags
    
    - name: Create GitHub Release
      uses: actions/github-script@v7
      with:
        script: |
          const version = '${{ needs.version-bump.outputs.new_version }}';
          
          await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: `v${version}`,
            name: `Release v${version}`,
            body: `## Release v${version}\n\n` +
                  `Published to:\n` +
                  `- PyPI: https://pypi.org/project/neuracore-types/${version}/\n` +
                  `- NPM: https://www.npmjs.com/package/@neuracore/types/v/${version}\n\n` +
                  `### Installation\n` +
                  `\`\`\`bash\n` +
                  `pip install neuracore-types==${version}\n` +
                  `npm install @neuracore/types@${version}\n` +
                  `\`\`\``,
            draft: false,
            prerelease: false
          });